# Consensus System Audit - Feb 3, 2026
**Last Updated:** 5:22 PM EST

## üö® CRITICAL FINDING
Build was failing due to TypeScript errors! Vercel was serving OLD code.
- `teamLower` variable defined twice (line 351 & 398)
- `NFL_TEAM_NO_GAMES` type not in RejectionReason union
**Fixed and pushed at 5:20 PM EST - awaiting Vercel deploy**

## üéØ Original Problem
Site showing bad consensus picks:
1. "New England:/Seattle Under 46" - NFL pick classified as NCAAB
2. "Florida +5" - Ghost pick (game doesn't exist)
3. "NC STATE ( ML" - Bad formatting (parenthesis in name)

## üìù Changes Made Today

### 1. Google Doc Parser (`src/lib/data/google-sheets.ts`)
**Commits:** f5cc6e0, 693f6e8, 6c5f823

| Change | Purpose | Status |
|--------|---------|--------|
| Added 'nfl football' ‚Üí 'NFL' sport mapping | Detect NFL Football: headers | ‚úÖ Deployed |
| Modified pick regex to allow whitespace prefix | Handle lines without bullet points | ‚úÖ Deployed |
| Added debug logging for Seattle picks | Trace sport classification | ‚úÖ Deployed |

### 2. Consensus Builder (`src/lib/consensus/consensus-builder.ts`)
**Commits:** 99477a0, 3b654ff, df4b72b

| Change | Purpose | Status |
|--------|---------|--------|
| Added "Exclusive"/"Exclusive PLAY" dedup | Same capper, one vote | ‚úÖ Deployed |
| Added trailing comma/punctuation cleanup | Fix "Matchpointbets," | ‚úÖ Deployed |

### 3. API Route (`src/app/api/consensus/route.ts`)
**Commits:** bbc7710, b638058

| Change | Purpose | Status |
|--------|---------|--------|
| HOTFIX: NFL team name filter | Remove NFL picks when 0 games | ‚ö†Ô∏è Not working |
| HOTFIX: @ and vs filter | Remove matchup-format picks | ‚ö†Ô∏è Not working |
| HOTFIX: Bad format filter | Remove picks with ( or : | ‚ö†Ô∏è Not working |

### 4. ESPN Filter (`src/lib/consensus/game-schedule.ts`)
**Commits:** 3b654ff

| Change | Purpose | Status |
|--------|---------|--------|
| Reject picks when sport has 0 games | Filter NFL/MLB when no games | ‚ö†Ô∏è Not triggering |

## üî¥ Current Issues

### Issue 1: HOTFIX Not Working
The filter in route.ts isn't filtering bad picks despite being deployed.
- "Seattle @ New England:" still showing
- "Bulls @ Bucks" still showing (@ format)
- NFL picks still getting through

**Root Cause Hypothesis:**
- Vercel function caching old code
- Filter running AFTER picks are added to response
- Logic error in filter conditions

### Issue 2: Sport Classification
NFL picks being classified as NCAAB in parser.
- Parser SHOULD detect `[OCR] NFL Football:` header
- But picks still show sport="NCAAB"

**Root Cause Hypothesis:**
- Sport header detection working but sport not persisting
- Pick line not matching regex (whitespace/encoding issue)
- Multiple parser paths, wrong one being used

## üîí Security Review

| Item | Status | Notes |
|------|--------|-------|
| No hardcoded API keys | ‚úÖ | ESPN API is public, no auth |
| No user input in queries | ‚úÖ | Data from Google Doc only |
| No SQL injection risk | ‚úÖ | No database queries |
| No XSS risk | ‚úÖ | API returns JSON only |
| Rate limiting | ‚ö†Ô∏è | No rate limiting on API |

## üìä Code Quality Review

### Good Practices Used:
- ‚úÖ TypeScript types for picks and consensus
- ‚úÖ Modular code (separate files for parsing, filtering, building)
- ‚úÖ Console logging for debugging
- ‚úÖ Git commits with descriptive messages
- ‚úÖ ESPN API for real-time game validation

### Issues Found:
- ‚ùå Multiple filter functions with overlapping logic
- ‚ùå Sport detection spread across multiple files
- ‚ùå No unit tests for parser logic
- ‚ùå Hotfix code is a bandaid, not a proper fix
- ‚ùå Too many debug commits cluttering history

## üõ†Ô∏è Recommended Fixes

### Immediate (Today):
1. **Verify Vercel deployment** - Check if latest code is actually running
2. **Add explicit NFL rejection** in ESPN filter (not hotfix)
3. **Fix parser sport persistence** - Ensure sport carries to next line

### Short-term (This Week):
1. **Consolidate filter logic** - One place for all filtering
2. **Add unit tests** for parser and filters
3. **Remove debug commits** - Squash into clean history

### Long-term:
1. **Proper architecture** - Separate concerns clearly
2. **Error handling** - Graceful failures
3. **Monitoring** - Alert when bad picks detected

## üìÅ Files Modified

```
src/lib/data/google-sheets.ts        - Parser
src/lib/consensus/consensus-builder.ts - Normalization
src/lib/consensus/game-schedule.ts   - ESPN filter
src/app/api/consensus/route.ts       - API endpoint
```

## üîÑ Deployment Status

Last push: b638058 (HOTFIX v2)
Branch: master
Platform: Vercel

**Vercel may have caching issues - consider manual redeploy**
